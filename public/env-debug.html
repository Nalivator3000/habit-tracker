<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environment Debug - Habit Tracker</title>
    <style>
        body {
            font-family: monospace;
            margin: 2rem;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #333;
            border-radius: 8px;
            background: #222;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #444;
        }
        pre {
            background: #111;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Environment & Database Debug</h1>
        <div class="section">
            <h2>Build Information</h2>
            <pre>
Build: HABIT-TRACKER-2025.09.21-15:35 ‚úÖ ROOT USER SETUP
Commit: 60fd97c - Remove email validation and add root user setup
Features: PostgreSQL, JWT Auth, Admin Tools, Root User
Status: Production Ready
            </pre>
        </div>

        <div class="section">
            <h2>Database Connection Tests</h2>
            <button onclick="testHealthEndpoint()">Test Health Endpoint</button>
            <button onclick="testEnvironmentVariables()">Test Environment Variables</button>
            <button onclick="testDatabaseEndpoint()">Test Database Debug</button>
            <button onclick="testAdminEndpoint()">Test Admin Endpoint</button>
            <button onclick="testDatabaseTables()">Test Database Tables</button>
            <button onclick="checkUsersSchema()">Check Users Schema</button>
            <button onclick="testDatabaseQueries()">Test Database Queries</button>
            <button onclick="initializeDatabase()">Initialize Database</button>
            <button onclick="fixDatabaseSchema()">Fix Database Schema</button>
            <button onclick="setupRootUser()">Setup Root User</button>
            <button onclick="runAllDatabaseTests()">Run All DB Tests</button>
            <div id="dbResults"></div>
        </div>

        <div class="section">
            <h2>Login Testing</h2>
            <div>
                <input type="text" id="testEmail" value="root" placeholder="Username">
                <input type="password" id="testPassword" value="root" placeholder="Password">
                <button onclick="testDetailedLogin()">Test Detailed Login</button>
            </div>
            <div id="loginResults"></div>
        </div>

        <div class="section">
            <h2>Manual Admin Creation</h2>
            <div>
                <input type="text" id="adminEmail" value="root" placeholder="Email">
                <input type="password" id="adminPassword" value="root" placeholder="Password">
                <input type="text" id="adminName" value="Root Admin" placeholder="Name">
                <button onclick="createAdmin()">Create Admin</button>
            </div>
            <div id="adminResults"></div>
        </div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const timestamp = new Date().toISOString();
            const colors = {
                success: 'success',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            const container = document.getElementById(containerId);
            container.innerHTML += `<div class="${colors[type]}">[${timestamp}] ${message}</div>`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testHealthEndpoint() {
            log('dbResults', 'Testing /health endpoint...', 'info');
            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Health Response: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ö†Ô∏è Health Issues: ${JSON.stringify(data, null, 2)}`, 'warning');
                }
            } catch (error) {
                log('dbResults', `‚ùå Health Check Failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseEndpoint() {
            log('dbResults', 'Testing /debug/database endpoint...', 'info');
            try {
                const response = await fetch('/debug/database');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Database Debug: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Database Debug Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Database Debug Failed: ${error.message}`, 'error');
            }
        }

        async function testAdminEndpoint() {
            log('dbResults', 'Testing /api/admin/test-db endpoint...', 'info');
            try {
                const response = await fetch('/api/admin/test-db');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Admin Test: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Admin Test Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Admin Test Failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseTables() {
            log('dbResults', 'Testing database tables...', 'info');
            try {
                const response = await fetch('/api/admin/test-tables');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Database Tables: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Table Test Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Table Test Failed: ${error.message}`, 'error');
            }
        }

        async function checkUsersSchema() {
            log('dbResults', 'Checking users table schema...', 'info');
            try {
                // Use the existing test-tables endpoint to get users table structure
                const response = await fetch('/api/admin/test-tables');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `üìã Users Table Structure:`, 'info');
                    if (data.usersTableStructure) {
                        data.usersTableStructure.forEach(col => {
                            const hasIsActive = col.column_name === 'is_active';
                            log('dbResults', `  ${col.column_name}: ${col.data_type} ${hasIsActive ? '‚úÖ' : ''}`, hasIsActive ? 'success' : 'info');
                        });

                        const hasIsActive = data.usersTableStructure.some(col => col.column_name === 'is_active');
                        if (hasIsActive) {
                            log('dbResults', `‚úÖ is_active column EXISTS`, 'success');
                        } else {
                            log('dbResults', `‚ùå is_active column MISSING - need to fix schema again`, 'error');
                        }
                    }
                } else {
                    log('dbResults', `‚ùå Schema Check Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Schema Check Failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseQueries() {
            log('dbResults', 'Testing database queries...', 'info');
            try {
                const response = await fetch('/api/admin/test-queries');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Database Queries: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Query Test Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Query Test Failed: ${error.message}`, 'error');
            }
        }

        async function testEnvironmentVariables() {
            log('dbResults', 'Testing environment variables...', 'info');
            try {
                const response = await fetch('/api/admin/test-env');
                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Environment Variables:`, 'success');
                    log('dbResults', `üìä Summary: ${JSON.stringify(data.summary, null, 2)}`, 'info');
                    log('dbResults', `üîß Variables: ${JSON.stringify(data.environment, null, 2)}`, 'info');

                    // Specific diagnostics
                    if (!data.summary.hasAnyDbVars) {
                        log('dbResults', `üö® PROBLEM: No database environment variables found at all!`, 'error');
                        log('dbResults', `üîß SOLUTION: Check Railway service linking`, 'warning');
                    } else if (!data.summary.hasPgVariables && !data.summary.hasDatabaseUrl) {
                        log('dbResults', `üö® PROBLEM: Database variables exist but not accessible`, 'error');
                        log('dbResults', `üîß Found variables: ${data.environment.allEnvVarNames.join(', ')}`, 'info');
                    }
                } else {
                    log('dbResults', `‚ùå Environment Test Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Environment Test Failed: ${error.message}`, 'error');
            }
        }

        async function initializeDatabase() {
            log('dbResults', 'Initializing database tables...', 'info');
            try {
                const response = await fetch('/api/admin/init-database', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Database Initialized: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Database Init Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Database Init Failed: ${error.message}`, 'error');
            }
        }

        async function runAllDatabaseTests() {
            log('dbResults', 'üîÑ Running comprehensive database tests...', 'info');
            document.getElementById('dbResults').innerHTML = '';

            await testHealthEndpoint();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testDatabaseEndpoint();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testDatabaseTables();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testDatabaseQueries();
            await new Promise(resolve => setTimeout(resolve, 500));

            await testAdminEndpoint();

            log('dbResults', 'üéâ All database tests completed!', 'success');
        }

        async function fixDatabaseSchema() {
            log('dbResults', 'Fixing database schema (adding missing columns)...', 'info');
            try {
                const response = await fetch('/api/admin/fix-schema', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Schema Fixed: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    log('dbResults', `‚ùå Schema Fix Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Schema Fix Failed: ${error.message}`, 'error');
            }
        }

        async function setupRootUser() {
            log('dbResults', 'Setting up root user (clearing all users)...', 'info');
            try {
                const response = await fetch('/api/admin/setup-root', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    log('dbResults', `‚úÖ Root User Setup: ${JSON.stringify(data, null, 2)}`, 'success');

                    // Test login immediately
                    log('dbResults', 'Testing root login...', 'info');
                    try {
                        const loginResponse = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email: 'root', password: 'root' })
                        });

                        const loginData = await loginResponse.json();
                        log('dbResults', `Root Login Status: ${loginResponse.status}`, 'info');
                        log('dbResults', `Root Login Data: ${JSON.stringify(loginData, null, 2)}`, loginResponse.ok ? 'success' : 'error');
                    } catch (loginError) {
                        log('dbResults', `‚ùå Root Login Failed: ${loginError.message}`, 'error');
                    }
                } else {
                    log('dbResults', `‚ùå Root Setup Error: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('dbResults', `‚ùå Root Setup Failed: ${error.message}`, 'error');
            }
        }

        async function testDetailedLogin() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;

            log('loginResults', `Testing detailed login: ${email}`, 'info');

            try {
                const response = await fetch('/api/admin/test-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                log('loginResults', `Test Login Response: ${JSON.stringify(data, null, 2)}`, data.success ? 'success' : 'error');

                // Also test the real login endpoint
                log('loginResults', 'Testing real login endpoint...', 'info');
                try {
                    const realLoginResponse = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });

                    const realLoginData = await realLoginResponse.json();
                    log('loginResults', `Real Login Status: ${realLoginResponse.status}`, 'info');
                    log('loginResults', `Real Login Data: ${JSON.stringify(realLoginData, null, 2)}`, realLoginResponse.ok ? 'success' : 'error');
                } catch (realLoginError) {
                    log('loginResults', `‚ùå Real Login Failed: ${realLoginError.message}`, 'error');
                }

            } catch (error) {
                log('loginResults', `‚ùå Test Login Failed: ${error.message}`, 'error');
            }
        }

        async function createAdmin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const name = document.getElementById('adminName').value;

            log('adminResults', `Creating admin: ${email}`, 'info');

            try {
                const response = await fetch('/api/admin/create-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password, name })
                });

                const data = await response.json();

                log('adminResults', `Response Status: ${response.status}`, 'info');
                log('adminResults', `Response Data: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');

                // Test login after creation
                if (response.ok) {
                    log('adminResults', 'Testing login after creation...', 'info');
                    try {
                        const loginResponse = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ email, password })
                        });

                        const loginData = await loginResponse.json();
                        log('adminResults', `Login Status: ${loginResponse.status}`, 'info');
                        log('adminResults', `Login Data: ${JSON.stringify(loginData, null, 2)}`, loginResponse.ok ? 'success' : 'error');
                    } catch (loginError) {
                        log('adminResults', `‚ùå Login Test Failed: ${loginError.message}`, 'error');
                    }
                }

            } catch (error) {
                log('adminResults', `‚ùå Admin Creation Failed: ${error.message}`, 'error');
            }
        }

        // Auto-run tests on load
        window.addEventListener('load', () => {
            log('dbResults', 'üöÄ Environment debug loaded', 'info');
            testHealthEndpoint();
        });
    </script>
</body>
</html>